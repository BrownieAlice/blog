---
title: "メールサーバを運用し始めた"
date: 2017-12-10T17:42:44+09:00
categories:
 - "diary"
tags:
  - "server"
toc: true
thumbnail: "images/mail_server/mail.png"
---
## メールサーバを借りた
Redmine/Nextcloud/Blog/wikiなどを運用し始めたので今度はメールサーバを運用しようと思いました.  
ただセキュリティガバガバなメールサーバを建てて乗っ取られると法的にしょっぴかれる可能性があるのでちょっと怖い. なのでお名前.comのお名前メールを利用することにしました.

## お名前メール
お名前メールは意外と安かったです. 後で色々と設定する必要があるのでスタンダードプランを利用する必要がありますが, 10GBで年920円なので気にするような金額ではないです.  
既存のドメインに結びつける感じでサービス登録するには, 1回ライトプラン(1ヶ月)で登録した後スタンダードプラン(1ヶ月)にしてスタンダードプラン(1年)に変更すれば良いです. ただコンビニ払いだと手数料が余分に2回かかるのでめうめう.  
その後は普通に登録していけばいいのですが, 設定周りがちょっとつらかったのでメモ.

### お名前メール設定
#### 前提
前提といて自分の状況を記載しておきます.  
ドメインもお名前.comで取得/管理しており, VPSも同じくお名前.comで利用しています. 同じドメインでメールだけはお名前メールの共用サーバで管理し, その他のサブドメインなどはVPSの方で管理したいという状況です.
#### 問題
まずお名前メールの共用サーバはIPは非公開です. そのためお名前メールの設定で諸々を管理したほうが良いのです.  
特定のドメインのメールは, そのドメインのMXレコードに基づいて行き先が決まります. ただMXレコードはそのネームサーバでAレコードで登録されているドメインである必要があります. そのためすでにMXレコードが上手く登録されているお名前メールのネームサーバで管理したほうが良いです.
#### 行ったこと
普通にドメインを取得してVPSをいじる際は `01.dnsv.jp` 等のネームサーバで管理されます. まずそれをお名前メールのネームサーバである `dns01.gmoserver.jp` 等のネームサーバに変更します.  
そしてお名前メールのネームサーバでサブドメインを追加(ライトプランだと不可能でスタンダードプランである必要があります)し, Aレコードを適切(VPSのIP)に設定すれば良いです.  
ネームサーバの変更がネットワークに反映されるには1日弱程度の時間がかかりました.
#### コマンド
ココらへんの設定をするのに便利なコマンドがあります.

* `dig` コマンド
  * ドメイン情報をDNSサーバから取得できます. 使い方は `dig browniealice.net` のようにします.
  * MXレコードを知る際には `dig browniealice.net mx` を打てば良いです.
* `nslookup` コマンド
  * IPアドレスを検索できます. 使い方は `nslookup browniealice.net`のようにします.
  * 特定のネームサーバに登録されているIPを検索するためには `nslookup browniealice.net dns01.gmoserver.jp` を打てば良いです.

## hello world
ネームサーバの変更がネットワークに浸透するのに少し時間がかかったがようやくできました.  
何か連絡したいことがあれば admin_at_browniealice.net (_at_を@に変換)まで.
